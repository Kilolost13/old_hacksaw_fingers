flowchart TD
    %% User Interaction Layer
    subgraph "User Interface Layer"
        U[ğŸ‘¤ User]
        F[âš›ï¸ React Frontend<br/>EnhancedDashboard]
        WS[ğŸ”„ WebSocket<br/>Real-time Updates]
    end

    %% API Gateway Layer
    subgraph "API Gateway Layer"
        G[ğŸšª Gateway Service<br/>FastAPI]
        Auth[ğŸ” Authentication<br/>JWT Tokens]
        RateLimit[âš¡ Rate Limiting]
    end

    %% Microservices Layer
    subgraph "Microservices Layer"
        H[ğŸ“Š Habits Service<br/>Habit Tracking]
        M[ğŸ’Š Medications Service<br/>Med Management]
        Fi[ğŸ’° Finance Service<br/>Financial Tracking]
        R[ğŸ”” Reminders Service<br/>Notification System]
        V[ğŸ¤ Voice Service<br/>Speech Processing]
        Cam[ğŸ“· Camera Service<br/>Image Processing]
        Lib[ğŸ“š Library Service<br/>Knowledge Base]
    end

    %% AI Brain Layer
    subgraph "AI Brain Layer"
        AI[ğŸ§  AI Brain Service<br/>Orchestrator]
        Mem[ğŸ—ƒï¸ Memory System<br/>Vector Database]
        Rag[ğŸ” RAG System<br/>Context Retrieval]
        Emb[ğŸ“ Embeddings<br/>Text Processing]
        Cons[ğŸ”„ Memory Consolidation<br/>Pattern Learning]
        Search[ğŸ” Memory Search<br/>Semantic Queries]
    end

    %% ML Engine Layer
    subgraph "ML Engine Layer"
        ML[ğŸ¤– ML Engine<br/>Model Serving]
        Insights[ğŸ’¡ Coaching Insights<br/>AI Analysis]
        Pred[ğŸ”® Predictions<br/>Pattern Recognition]
        Rec[ğŸ¯ Recommendations<br/>Personalized Coaching]
    end

    %% Data Storage Layer
    subgraph "Data Storage Layer"
        PG[ğŸ˜ PostgreSQL<br/>Relational Data]
        Redis[âš¡ Redis Cache<br/>Session & Cache]
        VecDB[ğŸ”— Vector Database<br/>Embeddings Storage]
        FileSys[ğŸ“ File System<br/>Images & Documents]
    end

    %% External Services Layer
    subgraph "External Services Layer"
        Ollama[ğŸ¦™ Ollama<br/>Local LLM]
        Models[ğŸ“¦ Model Storage<br/>Downloaded Models]
    end

    %% USB Data Transfer Layer
    subgraph "USB Data Transfer Layer"
        USB[ğŸ’¾ USB Module<br/>Secure Transfer]
        Encrypt[ğŸ”’ Encryption<br/>Data Protection]
        Validate[âœ… Data Validation<br/>Integrity Checks]
        Admin[ğŸ‘‘ Admin Interface<br/>Data Management]
        Export[ğŸ“¤ Data Export<br/>Therapy Progress]
        Import[ğŸ“¥ Data Import<br/>Bulk Data Loading]
    end

    %% Data Flow Connections
    U --> F
    F --> WS
    WS --> G

    F --> G
    G --> Auth
    G --> RateLimit

    G --> H
    G --> M
    G --> Fi
    G --> R
    G --> V
    G --> Cam
    G --> Lib

    H --> AI
    M --> AI
    Fi --> AI
    R --> AI
    V --> AI
    Cam --> AI
    Lib --> AI

    AI --> Mem
    AI --> Rag
    AI --> Emb
    AI --> Cons
    AI --> Search

    AI --> ML
    ML --> Insights
    ML --> Pred
    ML --> Rec

    AI --> PG
    AI --> Redis
    AI --> VecDB
    AI --> FileSys

    ML --> Ollama
    Ollama --> Models

    %% USB Module Connections
    Admin --> USB
    USB --> Encrypt
    USB --> Validate
    USB --> Export
    USB --> Import

    %% Feedback Loops
    Insights --> WS
    Rec --> WS
    Pred --> WS

    %% Data Export Flow
    PG --> Export
    VecDB --> Export
    FileSys --> Export
    Export --> Encrypt

    %% Data Import Flow
    Import --> Validate
    Validate --> PG
    Validate --> VecDB
    Validate --> FileSys

    %% Styling
    classDef userInterface fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef gateway fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef microservices fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef ai fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef ml fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef storage fill:#f9fbe7,stroke:#827717,stroke-width:2px
    classDef external fill:#efebe9,stroke:#3e2723,stroke-width:2px
    classDef usb fill:#e0f2f1,stroke:#004d40,stroke-width:2px

    class U,F,WS userInterface
    class G,Auth,RateLimit gateway
    class H,M,Fi,R,V,Cam,Lib microservices
    class AI,Mem,Rag,Emb,Cons,Search ai
    class ML,Insights,Pred,Rec ml
    class PG,Redis,VecDB,FileSys storage
    class Ollama,Models external
    class USB,Encrypt,Validate,Admin,Export,Import usb